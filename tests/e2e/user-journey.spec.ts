/**
 * Complete User Journey E2E Tests
 * End-to-end tests for critical user flows
 *
 * Generated by BMAD testarch-automate workflow
 * Priority: P0 (Critical)
 */

import { test, expect } from '../support/merged-fixtures';
import { createDecision, createMatch, createUser } from '../support/factories';
import { authenticateUser } from '../support/helpers/auth-helper';

test.describe('Critical User Journey - P0 @p0 @e2e @journey @critical', () => {
  test('[P0] should complete login to picks journey', async ({ page, api }) => {
    // Given: User logs in via API (fast setup)
    await authenticateUser(api, page);

    // When: User navigates to picks
    await page.goto('/dashboard/picks');

    // Then: Should see picks page
    await expect(page.getByTestId('picks-list')).toBeVisible();
    await expect(page.getByRole('heading', { name: /Picks/i })).toBeVisible();
  });

  test('[P0] should create decision and view in dashboard', async ({ page, api }) => {
    // Given: Authenticated user
    await authenticateUser(api, page);

    // And: A match and decision exist
    const match = createMatch();
    const decision = createDecision({ matchId: match.id });

    // Create decision via API
    await api.post('/api/decisions', { data: decision });

    // When: User views picks page
    await page.goto('/dashboard/picks');
    await page.waitForLoadState('networkidle');

    // Then: Should see the picks list
    await expect(page.getByTestId('picks-list')).toBeVisible({ timeout: 10000 });
  });

  test('[P1] should navigate between dashboard sections', async ({ page, api }) => {
    // Given: Authenticated user
    await authenticateUser(api, page);

    // When: User navigates through sections
    await page.goto('/dashboard/picks');
    await page.waitForLoadState('networkidle');
    await expect(page.getByTestId('picks-list')).toBeVisible({ timeout: 10000 });

    // Navigate to No-Bet using data-testid
    await page.getByTestId('nav-no-bet').click();
    await page.waitForLoadState('networkidle');
    await expect(page.getByTestId('no-bet-list')).toBeVisible({ timeout: 10000 });

    // Navigate to Logs using data-testid
    await page.getByTestId('nav-logs').click();
    await page.waitForLoadState('networkidle');
    await expect(page.getByTestId('logs-timeline')).toBeVisible({ timeout: 10000 });

    // Then: All sections accessible
    await expect(page).toHaveURL(/\/dashboard\/logs/);
  });

  test('[P1] should handle decision workflow end-to-end', async ({ page, api }) => {
    // Given: Authenticated user with match
    await authenticateUser(api, page);

    const match = createMatch();
    const decision = createDecision({ matchId: match.id, status: 'Pick' });

    // When: Create decision via API
    await api.post('/api/decisions', { data: decision });

    // And: View in picks
    await page.goto('/dashboard/picks');

    // Then: Decision visible
    await expect(page.getByTestId('picks-list')).toBeVisible();

    // And: Can view no-bet section
    await page.goto('/dashboard/no-bet');
    await expect(page.getByTestId('no-bet-list')).toBeVisible();

    // And: Can view logs
    await page.goto('/dashboard/logs');
    await expect(page.getByTestId('logs-timeline')).toBeVisible();
  });

  test('[P1] should maintain session across pages', async ({ page, api }) => {
    // Given: Authenticated user
    await authenticateUser(api, page);

    // When: Navigate to multiple pages
    await page.goto('/dashboard/picks');
    await page.goto('/dashboard/no-bet');
    await page.goto('/dashboard/logs');

    // Then: Still authenticated (no redirect to login)
    await expect(page).not.toHaveURL(/\/login/);
    await expect(page.getByTestId('logs-timeline')).toBeVisible();
  });
});
