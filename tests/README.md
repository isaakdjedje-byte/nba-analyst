# Test Framework Documentation

## NBA Analyst - Test Architecture

Generated by BMAD `testarch-framework` workflow on 2026-02-12

---

## Framework Overview

This project uses **Playwright** with `@seontechnologies/playwright-utils` for end-to-end testing.

### Selected Framework: Playwright

**Rationale:**
- ✅ Large codebase (36 FRs, 26 NFRs, 11-14 major components)
- ✅ Next.js App Router with API routes
- ✅ Heavy API + UI integration (policy engine, ML, ingestion)
- ✅ Performance requirements (p95 ≤ 2.0s)
- ✅ Cross-browser support for B2B readiness

---

## Directory Structure

```
tests/
├── e2e/                          # End-to-end tests
│   ├── dashboard-picks.spec.ts   # Picks dashboard tests
│   ├── no-bet-hard-stop.spec.ts # Policy enforcement tests
│   └── logs-replay.spec.ts      # Audit and replay tests
├── support/
│   ├── fixtures/                 # Test data fixtures
│   ├── helpers/                  # Test helpers and utilities
│   │   ├── global-setup.ts      # Global test setup
│   │   └── auth-provider.ts     # Authentication provider
│   ├── page-objects/             # Page object models (optional)
│   ├── factories/                # Data factories
│   │   └── index.ts             # User, Decision, Run, Match factories
│   ├── custom-fixtures.ts        # Project-specific fixtures
│   └── merged-fixtures.ts        # Combined fixtures export
├── support/.auth/                # Auth session storage (gitignored)
└── README.md                     # This file
```

---

## Getting Started

### Prerequisites

- Node.js 24+ (see `.nvmrc`)
- npm or yarn

### Installation

```bash
# Install Playwright and utils
npm install -D @playwright/test @seontechnologies/playwright-utils

# Install browsers
npx playwright install

# Install faker for factories
npm install -D @faker-js/faker
```

### Environment Setup

```bash
# Copy environment template
cp .env.example .env.local

# Edit .env.local with your values
TEST_ENV=local
BASE_URL=http://localhost:3000
API_URL=http://localhost:3000/api
TEST_USER_EMAIL=test@example.com
TEST_USER_PASSWORD=testpassword123
```

---

## Running Tests

### Local Development

```bash
# Run all tests
npx playwright test

# Run with UI mode
npx playwright test --ui

# Run specific test file
npx playwright test dashboard-picks.spec.ts

# Run with headed browser
npx playwright test --headed

# Debug mode
npx playwright test --debug
```

### CI/CD

```bash
# Run in CI mode (non-interactive)
npx playwright test --ci

# Generate report
npx playwright test --reporter=html
```

---

## Test Patterns

### Given/When/Then Format

All tests follow BDD-style Given/When/Then comments:

```typescript
test('should display picks list', async ({ page }) => {
  // Given the user is on the dashboard
  await page.goto('/dashboard/picks');

  // Then the picks list should be visible
  await expect(page.getByTestId('picks-list')).toBeVisible();
});
```

### Data-Testid Selectors

Use `data-testid` attributes for element selection:

```typescript
// ✅ Good
await page.getByTestId('picks-list').click();

// ❌ Avoid
await page.locator('.picks-list').click();
```

### Factory-Based Data

Use factories for dynamic, parallel-safe test data:

```typescript
import { createDecision, createMatch } from '../support/factories';

const match = createMatch();
const decision = createDecision({ matchId: match.id });
```

### API-First Setup

Seed data via API before UI interactions:

```typescript
test('should create pick via API', async ({ apiRequest }) => {
  const decision = createDecision();

  const { status, body } = await apiRequest({
    method: 'POST',
    path: '/api/decisions',
    body: decision,
  });

  expect(status).toBe(201);
});
```

---

## Fixtures

### Available Fixtures

| Fixture | Source | Description |
|---------|--------|-------------|
| `apiRequest` | playwright-utils | Typed HTTP client with retry |
| `authToken` | playwright-utils | Authenticated token management |
| `log` | playwright-utils | Report-integrated logging |
| `testUser` | custom-fixtures | Pre-seeded test user |
| `adminUser` | custom-fixtures | Pre-seeded admin user |
| `testDecision` | custom-fixtures | Pre-seeded decision |
| `testRun` | custom-fixtures | Pre-seeded run |
| `dbHelpers` | custom-fixtures | Database helper utilities |

### Using Fixtures

```typescript
import { test, expect } from '../support/merged-fixtures';

test('example', async ({ apiRequest, authToken, testUser }) => {
  // All fixtures available
});
```

---

## Factories

### Available Factories

```typescript
import {
  createUser,           // Basic user
  createAdminUser,     // Admin user
  createDecision,      // Pick decision
  createNoBetDecision, // No-bet decision
  createHardStopDecision, // Hard-stop decision
  createRun,           // Completed run
  createFailedRun,     // Failed run
  createMatch,         // NBA match
} from '../support/factories';
```

### Factory Overrides

```typescript
const user = createUser({
  email: 'custom@example.com',
  role: 'admin'
});
```

---

## Configuration

### playwright.config.ts

- **Timeouts**: Action 15s, Navigation 30s, Test 60s
- **Base URL**: From `BASE_URL` env var
- **Artifacts**: Trace, screenshot, video on failure
- **Reporters**: HTML + JUnit + console
- **Browsers**: Chromium, Firefox, WebKit + Mobile
- **Parallel**: Enabled locally, 1 worker on CI

### Global Setup

- Authenticates default test user before all tests
- Saves auth state to `./tests/support/.auth/`
- Reuses authentication across test runs

---

## Authentication

### Auth Provider

Custom auth provider at `tests/support/helpers/auth-provider.ts`:

- Token persistence to disk
- Automatic token refresh
- Multi-user support

### Auth Session Files

Sessions stored in `tests/support/.auth/`:
- `default-user.json` - Default authenticated user

### Using Auth in Tests

```typescript
test('authenticated test', async ({ authToken, apiRequest }) => {
  const { body } = await apiRequest({
    method: 'GET',
    path: '/api/protected',
    headers: { Authorization: `Bearer ${authToken}` },
  });
});
```

---

## Best Practices

### ✅ Do

- Use factories for dynamic data
- Use data-testid selectors
- Seed data via API before UI
- Use Given/When/Then comments
- Clean up in afterEach
- Use type-safe fixtures
- Validate API responses

### ❌ Don't

- Hardcode test data
- Use CSS classes for selectors
- Create data through UI interactions
- Skip cleanup
- Mix direct and fixture imports

---

## Troubleshooting

### Tests Fail to Start

```bash
# Reinstall browsers
npx playwright install --force

# Check Node version
node --version  # Should be 24+
```

### Auth Issues

```bash
# Clear auth cache
rm -rf tests/support/.auth/

# Re-run global setup
npx playwright test --global-setup
```

### Flaky Tests

- Check for race conditions
- Use `recurse` for async operations
- Add explicit waits for loading states
- Review test isolation

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Playwright Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
```

---

## Additional Resources

- [Playwright Documentation](https://playwright.dev)
- [Playwright Utils Documentation](https://github.com/seontechnologies/playwright-utils)
- [Project Architecture](../../_bmad-output/planning-artifacts/architecture.md)

---

## Support

For questions about the test framework, refer to:
1. This README
2. Architecture documentation
3. Knowledge fragments in `_bmad/tea/testarch/knowledge/`

---

*Generated by BMAD Framework v6.0.0*
